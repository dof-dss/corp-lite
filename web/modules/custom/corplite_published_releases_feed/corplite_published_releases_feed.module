<?php

/**
 * @file
 * Contains corplite_published_releases_feed.module.
 */

use Drupal\corplite_published_releases_feed\Entity\PublishedReleases;
use Drupal\Core\Render\Element;
use Drupal\taxonomy\Entity\Vocabulary;

/**
 * Cron callback function to run feed.
 */
function corplite_published_releases_feed_import() {
  $data = corplite_published_releases_feed_fetch_feed();
  $organisations = corplite_published_releases_retrieve_organisations();
  $document_types = corplite_published_releases_retrieve_document_types();
  $updated = 0;
  $imported = 0;
  foreach ($data as $feed_item) {
    // If the id is longer than 120 chars then trim it before storing,
    // this is because it will cause problems in the 'item_id' column of
    // the search_api_item table.
    if (strlen($feed_item['id']) > 120) {
      $feed_item['id'] = substr($feed_item['id'], 0, 120);
    }
    $release = PublishedReleases::Load($feed_item['id']);
    if (!empty($release)) {
      // Published release exists, see if we need to update it.
      if (strtotime($feed_item['updated']) > $release->updated->getString()) {
        // Update the published release.
        corplite_published_releases_feed_update_release_object($release, $feed_item, $organisations, $document_types);
        $updated++;
      }
      else {
        // Published release has not changed, do nothing.
      }
    }
    else {
      // Published release does not exist in the database, so store it.
      $release = PublishedReleases::create(['id' => $feed_item['id']]);
      corplite_published_releases_feed_update_release_object($release, $feed_item, $organisations, $document_types);
      $imported++;
    }
  }
  \Drupal::logger('corplite_published_releases_feed')->notice("Nisra published releases feed - imported " . $imported . ", updated " . $updated);
}

/**
 * Retrieve the 'organisations' vocabulary.
 */
function corplite_published_releases_retrieve_organisations() {
  $organisations = [];
  $organisations_vocabulary = Vocabulary::load('organisations');
  if (!empty($organisations_vocabulary)) {
    $tree = \Drupal::entityTypeManager()->getStorage('taxonomy_term')->loadTree($organisations_vocabulary->id());
    foreach ($tree as $item) {
      $organisations[$item->name] = strip_tags($item->description__value);
    }
  }
  return $organisations;
}

/**
 * Retrieve the 'document types' vocabulary.
 */
function corplite_published_releases_retrieve_document_types() {
  $types = [];
  $doc_type_vocabulary = Vocabulary::load('document_types');
  if (!empty($doc_type_vocabulary)) {
    $tree = \Drupal::entityTypeManager()->getStorage('taxonomy_term')->loadTree($doc_type_vocabulary->id());
    foreach ($tree as $item) {
      $types[$item->name] = strip_tags($item->description__value);
    }
  }
  return $types;
}

/**
 * Update the release object.
 */
function corplite_published_releases_feed_update_release_object($release, $feed_item, $organisations, $document_types) {
  $release->set('title', $feed_item['title']);
  $release->set('summary', $feed_item['summary']);
  $release->set('url', $feed_item['url']);
  $release->set('release_date', strtotime($feed_item['release_date']));
  $release->set('display_date', $feed_item['display_date']);
  $release->set('updated', strtotime($feed_item['updated']));
  // Lookup 'type' against taxonomy.
  $type = '';
  if (!empty($feed_item['type'])) {
    $type = $document_types[$feed_item['type']];
  }
  $release->set('type', $type);
  // Lookup 'organisation' in taxonomy.
  $org = '';
  if (!empty($feed_item['org'])) {
    $org = $organisations[$feed_item['org']];
  }
  $release->set('org', $org);
  $release->save();
}

/**
 * Retrieve the JSON feed.
 */
function corplite_published_releases_feed_fetch_feed() {
  $data = NULL;
  $client = \Drupal::service('http_client');
  $config = \Drupal::config('corplite_published_releases_feed.settings');
  $url = $config->get('data_source_url');

  try {
    $response = $client->get($url);

    if ($response->getStatusCode() == 200) {
      $feed_contents = $response->getBody()->getContents();

      // TODO Temporarily set feed contents for testing only - remove before releasing
      $feed_contents = '{
    "name": "nisra release calendar",
    "modified": "2025-10-08T08:42:55Z",
    "entries": [
        {
            "id": "investment-in-general-practice-northern-ireland-2020-21-to-2024-25",
            "title": "Investment in General Practice, Northern Ireland 2020-21 to 2024-25",
            "summary": "Document type: Official Statistics. This report details investment in general practice and the reimbursement for drugs dispensed in general practices in Northern Ireland.",
            "url": "https://www.health-ni.gov.uk/articles/investment-general-practice",
            "release_date": "2025-10-03T09:30:00Z",
            "display_date": "3 October 2025",
            "updated": "2025-10-03T16:30:01Z",
            "type": "OS",
            "org": "DfI"
        },
        {
            "id": "deaths-registered-in-northern-ireland-week-ending-26-sept-2025",
            "title": "Deaths Registered in Northern Ireland - Week ending 26 Sept 2025",
            "summary": "Document type: Accredited official statistics. Tables showing deaths registered in Northern Ireland in 2025, up to and including 26 September 2025.",
            "url": "https://www.nisra.gov.uk/statistics/death-statistics/weekly-death-registrations-northern-ireland",
            "release_date": "2025-10-03T09:30:00Z",
            "display_date": "3 October 2025",
            "updated": "2025-10-03T09:30:01Z",
            "type": "OS",
            "org": "DfE"
        },
        {
            "id": "monthly-occupancy-statistics-august-2025",
            "title": "Monthly Occupancy Statistics, August 2025",
            "summary": "Document type: Official Statistics. The monthly occupancy survey provides information on the occupancy rates and rooms and beds sold in Northern Ireland.",
            "url": "https://www.nisra.gov.uk/statistics/tourism/occupancy-surveys",
            "release_date": "2025-10-02T09:30:00Z",
            "display_date": "2 October 2025",
            "updated": "2025-10-02T09:30:01Z",
            "type": "R",
            "org": "DAERA"
        },
        {
            "id": "experience-of-volunteering-by-adults-in-northern-ireland-202425",
            "title": "Experience of volunteering by adults in Northern Ireland, 2024/25",
            "summary": "Document type: Official Statistics. An annual publication containing survey results on volunteering by adults in Northern Ireland.",
            "url": "https://www.communities-ni.gov.uk/topics/statistics-and-research/voluntary-and-community-statistics",
            "release_date": "2025-10-02T09:30:00Z",
            "display_date": "2 October 2025",
            "updated": "2025-10-02T09:30:01Z",
            "type": "AOS",
            "org": "DfI"
        },
        {
            "id": "northern-ireland-waiting-time-statistics-cancer-waiting-times-april-june-2025",
            "title": "Northern Ireland waiting time statistics: cancer waiting times April - June 2025",
            "summary": "Document type: Accredited official statistics. Presents information on waiting times for patients accessing cancer services at hospitals in Northern Ireland during each quarter.",
            "url": "https://www.health-ni.gov.uk/articles/cancer-waiting-times",
            "release_date": "2025-10-02T09:30:00Z",
            "display_date": "2 October 2025",
            "updated": "2025-10-02T09:30:01Z",
            "type": "R",
            "org": "DfE"
        }]}';

      $feed_contents = json_decode($feed_contents, TRUE);

      $data = [];
      foreach ($feed_contents['entries'] as $row) {
        if (!empty($row['id'])) {
          $data[] = [
            'id' => (string) $row['id'],
            'title' => (string) !empty($row['title']) ? $row['title'] : '',
            'summary' => (string) !empty($row['summary']) ? $row['summary'] : '',
            'url' => (string) !empty($row['url']) ? $row['url'] : '',
            'release_date' => (string) !empty($row['release_date']) ? $row['release_date'] : '',
            'display_date' => (string) !empty($row['display_date']) ? $row['display_date'] : '',
            'updated' => (string) !empty($row['updated']) ? $row['updated'] : '',
            /* Fallback code as 'type' was initially appearing incorrectly in the feed as 'release_type'. */
            'type' => (string) !empty($row['type']) ? $row['type'] : (!empty($row['release_type']) ?$row['release_type'] : ''),
            'org' => (string) !empty($row['org']) ? $row['org'] : ''
          ];
        }
      }
    }
  }
  catch (Exception $e) {
    \Drupal::logger('corplite_published_releases_feed')->error($e);
  }
  return $data;
}

/**
 * Implements hook_facets_search_api_query_type_mapping_alter().
 */
function corplite_published_releases_feed_facets_search_api_query_type_mapping_alter($backend_plugin_id, array &$query_types) {
  $query_types['example'] = 'now_future_dates';
}

/**
 * Implements hook_theme().
 */
function corplite_published_releases_feed_theme(): array {
  return [
    'published_releases' => ['render element' => 'elements'],
  ];
}

/**
 * Prepares variables for published releases templates.
 *
 * Default template: published-releases.html.twig.
 *
 * @param array $variables
 *   An associative array containing:
 *   - elements: An associative array containing the published releases information and any
 *     fields attached to the entity.
 *   - attributes: HTML attributes for the containing element.
 */
function template_preprocess_published_releases(array &$variables): void {
  $variables['view_mode'] = $variables['elements']['#view_mode'];
  foreach (Element::children($variables['elements']) as $key) {
    $variables['content'][$key] = $variables['elements'][$key];
  }
}
